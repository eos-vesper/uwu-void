<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>SIGIL FORGE</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=VT323&display=swap');

* { box-sizing:border-box; margin:0; padding:0; -webkit-tap-highlight-color:transparent; }
html,body {
  width:100%; height:100%; background:#000;
  overflow:hidden; touch-action:none;
  font-family:'Share Tech Mono',monospace;
}
body::before {
  content:''; position:fixed; inset:0; pointer-events:none; z-index:3000;
  background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,0.1) 2px,rgba(0,0,0,0.1) 4px);
}
body::after {
  content:''; position:fixed; inset:0; pointer-events:none; z-index:2999;
  background:radial-gradient(ellipse at center,transparent 42%,rgba(0,0,0,0.92) 100%);
}
#plasma { position:fixed; inset:0; z-index:0; opacity:0.13; }

/* BOOT */
#boot {
  position:fixed; inset:0; background:#000; z-index:4000;
  display:flex; flex-direction:column; align-items:center; justify-content:center;
  padding:2rem; transition:opacity 0.7s;
}
#boot.hidden { opacity:0; pointer-events:none; }
.btext { font-family:'VT323',monospace; font-size:1.05rem; line-height:1.9; width:100%; max-width:360px; }
.bline { opacity:0; animation:brev 0.05s forwards; }
@keyframes brev { to{opacity:1;} }
#bootbtn {
  margin-top:2rem; padding:0.9rem 2.2rem; background:transparent;
  font-family:'VT323',monospace; font-size:1.7rem; letter-spacing:4px;
  cursor:pointer; opacity:0; animation:brev 0.3s 3s forwards; transition:all 0.2s;
}

/* APP */
#app {
  position:fixed; inset:0; z-index:10;
  display:flex; flex-direction:column;
  opacity:0; transition:opacity 0.9s;
  background:rgba(0,0,5,0.78);
}
#app.visible { opacity:1; }

/* HEADER */
.hdr {
  flex-shrink:0; padding:0.5rem 0.9rem; border-bottom:1px solid;
  display:flex; justify-content:space-between; align-items:center;
  background:rgba(0,0,0,0.55);
}
.htitle { font-family:'VT323',monospace; font-size:1.2rem; letter-spacing:3px; }
.hright { font-size:0.55rem; text-align:right; line-height:1.8; opacity:0.65; }
.sdot {
  display:inline-block; width:6px; height:6px; border-radius:50%;
  margin-right:3px; vertical-align:middle; animation:sdp 1.8s infinite;
}
@keyframes sdp { 0%,100%{opacity:1;} 50%{opacity:0.1;} }

/* MODULES */
.modules { flex:1; display:flex; flex-direction:column; overflow:hidden; min-height:0; }
.mod {
  position:relative; border-bottom:1px solid;
  background:rgba(0,0,4,0.45); overflow:hidden;
}
.mod:last-child { border-bottom:none; }
.mlbl { position:absolute; top:0.35rem; left:0.65rem; font-size:0.55rem; letter-spacing:2px; z-index:10; opacity:0.5; pointer-events:none; }
.mid  { position:absolute; top:0.35rem; right:0.65rem; font-size:0.55rem; z-index:10; opacity:0.3; pointer-events:none; }
.mod::before,.mod::after { content:''; position:absolute; width:10px; height:10px; border-style:solid; opacity:0.3; z-index:5; pointer-events:none; }
.mod::before { top:3px; left:3px; border-width:1px 0 0 1px; }
.mod::after  { bottom:3px; right:3px; border-width:0 1px 1px 0; }

/* MOD 1: FORGE CANVAS */
#fmod { flex:1.65; }
#forge-wrap { position:relative; width:100%; height:100%; overflow:hidden; }
#sigil-canvas,#glitch-canvas,#chroma-canvas {
  position:absolute; inset:0; width:100%; height:100%;
}
#sigil-canvas  { z-index:1; }
#glitch-canvas { z-index:2; pointer-events:none; }
#chroma-canvas { z-index:3; pointer-events:none; mix-blend-mode:screen; }

#forge-hint {
  position:absolute; inset:0; z-index:4; pointer-events:none;
  display:flex; flex-direction:column; align-items:center; justify-content:center; gap:0.6rem;
  transition:opacity 0.5s;
}
.hint-sym { font-family:'VT323',monospace; font-size:2.8rem; opacity:0.12; }
.hint-txt { font-size:0.58rem; letter-spacing:3px; opacity:0.18; text-align:center; line-height:2.1; }

#inst-wrap { position:absolute; bottom:0; left:0; right:0; z-index:6; height:3px; background:rgba(255,255,255,0.03); }
#inst-fill  { height:100%; width:0%; }

/* MOD 2: READING */
#rmod { flex:1.1; display:flex; flex-direction:column; }

.reading-body {
  flex:1; display:flex; align-items:center; justify-content:center;
  padding:1.2rem 1.1rem 0.4rem; position:relative; overflow:hidden;
}

.rtext {
  font-family:'VT323',monospace; font-size:1.15rem;
  letter-spacing:0.12em; line-height:1.55; text-align:center;
  white-space:pre-line; z-index:2; position:relative;
  opacity:0; transition:opacity 0.5s;
}
.rtext.show { opacity:1; }
.rtext::before,.rtext::after {
  content:attr(data-text); position:absolute; inset:0;
  text-align:center; white-space:pre-line; pointer-events:none;
}
.rtext::before { color:#ff00ff; opacity:0; animation:ga 2.8s infinite; clip-path:polygon(0 12%,100% 12%,100% 38%,0 38%); }
.rtext::after  { color:#00ffff; opacity:0; animation:gb 3.2s infinite; clip-path:polygon(0 60%,100% 60%,100% 84%,0 84%); }
.rtext.glitching::before { opacity:0.55; }
.rtext.glitching::after  { opacity:0.45; }
@keyframes ga { 0%,90%,100%{transform:none;} 91%{transform:translate(-3px,0) skewX(-2deg);} 94%{transform:translate(2px,0);} }
@keyframes gb { 0%,86%,100%{transform:none;} 87%{transform:translate(4px,0) skewX(2deg);} 91%{transform:translate(-2px,0);} }

.ridle { font-size:0.58rem; letter-spacing:2.5px; opacity:0.2; text-align:center; line-height:2; }

#crackle-canvas { position:absolute; inset:0; width:100%; height:100%; pointer-events:none; z-index:1; opacity:0.45; }

/* CONTROLS */
.ctrl-bar {
  flex-shrink:0; display:flex; align-items:center;
  padding:0.4rem 0.8rem; gap:0.6rem; border-top:1px solid; height:46px;
}
.ftog-wrap { display:flex; align-items:center; gap:0.4rem; flex-shrink:0; }
.ftog-lbl  { font-size:0.48rem; letter-spacing:0.15em; opacity:0.4; }
.ftog {
  position:relative; width:64px; height:24px; border:1px solid; border-radius:12px;
  cursor:pointer; background:rgba(0,0,0,0.4); flex-shrink:0; overflow:hidden;
}
.fthumb {
  position:absolute; top:3px; left:3px; width:18px; height:18px; border-radius:50%;
  transition:transform 0.3s cubic-bezier(0.4,0,0.2,1), background 0.3s;
}
.ftog.uwu .fthumb { transform:translateX(40px); }
.fmode { font-family:'VT323',monospace; font-size:1rem; letter-spacing:1px; white-space:nowrap; flex-shrink:0; min-width:72px; transition:all 0.3s; }
.clear-btn {
  background:transparent; border:1px solid; font-family:'Share Tech Mono',monospace;
  font-size:0.53rem; letter-spacing:2px; padding:0.35rem 0.65rem;
  cursor:pointer; transition:all 0.2s; flex-shrink:0;
}
.clear-btn:active { transform:scale(0.95); opacity:0.6; }
#state-lbl { flex:1; font-size:0.48rem; letter-spacing:0.1em; opacity:0.38; text-align:right; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

/* FOOTER */
.ftr {
  flex-shrink:0; padding:0.25rem 0.9rem; border-top:1px solid;
  display:flex; justify-content:space-between; font-size:0.47rem; letter-spacing:0.1em; opacity:0.35;
}

/* WOOSH */
#woosh { position:fixed; inset:0; pointer-events:none; z-index:2500; }
.wring { position:absolute; border-radius:50%; border:2px solid; transform:scale(0); opacity:0; }

.uwusp { position:fixed; pointer-events:none; z-index:2490; font-size:1rem; animation:spf 1.4s ease-out forwards; }
@keyframes spf { 0%{opacity:1;transform:translateY(0) scale(1);} 100%{opacity:0;transform:translateY(-80px) scale(0.2);} }
</style>
</head>
<body>

<canvas id="plasma"></canvas>
<div id="woosh"></div>

<div id="boot">
  <div class="btext" id="btext"></div>
  <button id="bootbtn" onclick="activate()">[ OPEN THE FORGE ]</button>
</div>

<div id="app">
  <div class="hdr" id="hdr">
    <div class="htitle" id="htitle">SIGIL FORGE</div>
    <div class="hright"><span class="sdot" id="sdot"></span>FORGING<br><span id="stime">00:00:00</span></div>
  </div>

  <div class="modules">
    <div class="mod" id="fmod">
      <div class="mlbl" id="lbl1">// SIGIL CANVAS</div>
      <div class="mid">MOD-01</div>
      <div id="forge-wrap">
        <canvas id="sigil-canvas"></canvas>
        <canvas id="glitch-canvas"></canvas>
        <canvas id="chroma-canvas"></canvas>
        <div id="forge-hint">
          <div class="hint-sym" id="hsym">⬡</div>
          <div class="hint-txt" id="htxt">DRAW YOUR SIGIL<br>THE FORGE WILL READ IT</div>
        </div>
        <div id="inst-wrap"><div id="inst-fill"></div></div>
      </div>
    </div>

    <div class="mod" id="rmod">
      <div class="mlbl" id="lbl2">// VOID READING</div>
      <div class="mid">MOD-02</div>
      <div class="reading-body">
        <canvas id="crackle-canvas"></canvas>
        <div class="ridle" id="ridle">— inscribe a sigil above —</div>
        <div class="rtext" id="rtext" data-text=""></div>
      </div>
      <div class="ctrl-bar" id="ctrlbar">
        <div class="ftog-wrap">
          <span class="ftog-lbl">MODE</span>
          <div class="ftog eldritch" id="ftog" onclick="toggleFilter()"><div class="fthumb" id="fthumb"></div></div>
          <span class="fmode" id="fmode">ELDRITCH</span>
        </div>
        <button class="clear-btn" id="clearbtn" onclick="clearForge()">✕ CLEAR</button>
        <div id="state-lbl">— awaiting inscription —</div>
      </div>
    </div>
  </div>

  <div class="ftr" id="ftr">
    <span>⬡ SIGIL FORGE ⬡</span>
    <span id="ftval">glyphs=0000 reads=0000</span>
  </div>
</div>

<script>
'use strict';

// ── RAZOR ──
const RAZOR=[[0,255,65],[0,210,255],[170,0,255],[255,0,190],[255,170,0],[0,255,65]];
let RT=0, RC=[0,255,65], RS=[0,180,255], RTH=[140,0,255];
function lerpR(phase){
  let t=((phase%1)+1)%1, n=RAZOR.length-1, i=Math.floor(t*n), f=t*n-i;
  let a=RAZOR[i], b=RAZOR[Math.min(i+1,n)];
  return [Math.round(a[0]+(b[0]-a[0])*f),Math.round(a[1]+(b[1]-a[1])*f),Math.round(a[2]+(b[2]-a[2])*f)];
}
function rgb(c,a){ return a!=null?`rgba(${c[0]},${c[1]},${c[2]},${a})`:`rgb(${c[0]},${c[1]},${c[2]})`; }
function S(id){ return document.getElementById(id); }
function applyEl(id,fn){ let el=S(id); if(el) fn(el); }

let blooms=[];
function spawnBloom(x,y,col){
  blooms.push({x:x??Math.random()*window.innerWidth,y:y??Math.random()*window.innerHeight,r:0,maxR:70+Math.random()*160,color:col??lerpR(Math.random()),alpha:0.1+Math.random()*0.18});
}

function updateTheme(){
  RT+=0.016; RC=lerpR(RT*0.4); RS=lerpR(RT*0.4+0.35); RTH=lerpR(RT*0.4+0.7);
  if(Math.random()<0.016) spawnBloom();
  let ms=rgb(RC),md=rgb(RC,0.17),isUwu=filterMode==='uwu',fc=isUwu?lerpR(0.15):RTH;
  applyEl('htitle',el=>{el.style.color=ms;el.style.textShadow=`0 0 14px ${rgb(RC,0.28)}`;});
  applyEl('hdr',el=>el.style.borderColor=md);
  applyEl('sdot',el=>{el.style.background=ms;el.style.boxShadow=`0 0 8px ${ms}`;});
  applyEl('ftr',el=>{el.style.borderColor=md;el.style.color=rgb(RC,0.35);});
  applyEl('ctrlbar',el=>el.style.borderColor=md);
  ['fmod','rmod'].forEach((id,i)=>{ let c=lerpR(RT*0.4+i*0.4); applyEl(id,el=>el.style.borderColor=rgb(c,0.14)); });
  document.querySelectorAll('.mlbl').forEach((el,i)=>{ el.style.color=rgb(lerpR(RT*0.4+i*0.4),0.55); });
  applyEl('ftog',el=>{el.style.borderColor=rgb(fc,0.5);el.classList.toggle('uwu',isUwu);el.classList.toggle('eldritch',!isUwu);});
  applyEl('fthumb',el=>{el.style.background=rgb(fc);el.style.boxShadow=`0 0 6px ${rgb(fc)}`;});
  applyEl('fmode',el=>{el.textContent=isUwu?'UWU MODE':'ELDRITCH';el.style.color=rgb(fc);el.style.textShadow=`0 0 8px ${rgb(fc,0.5)}`;});
  applyEl('clearbtn',el=>{el.style.borderColor=rgb(RS,0.4);el.style.color=rgb(RS,0.6);});
  applyEl('state-lbl',el=>el.style.color=rgb(RC,0.38));
  applyEl('rtext',el=>{let rc2=isUwu?lerpR(RT*0.4+0.15):RC;el.style.color=rgb(rc2);el.style.textShadow=`0 0 10px ${rgb(rc2,0.55)},0 0 22px ${rgb(rc2,0.18)}`;});
  let ic=isUwu?lerpR(0.12+instability*0.25):RC;
  applyEl('inst-fill',el=>{el.style.background=rgb(ic);el.style.boxShadow=`0 0 ${4+instability*10}px ${rgb(ic)}`;el.style.width=(instability*100)+'%';});
  applyEl('hsym',el=>el.style.color=rgb(RC,0.12));
  applyEl('htxt',el=>el.style.color=rgb(RC,0.18));
  applyEl('bootbtn',el=>{el.style.borderColor=ms;el.style.color=ms;});
}

// ── PLASMA ──
let pCanvas,pCtx,pOff,pOffCtx,pT=0;
function initPlasma(){
  pCanvas=S('plasma'); pCanvas.width=window.innerWidth; pCanvas.height=window.innerHeight;
  pCtx=pCanvas.getContext('2d');
  pOff=document.createElement('canvas');
  pOff.width=Math.ceil(window.innerWidth/7); pOff.height=Math.ceil(window.innerHeight/7);
  pOffCtx=pOff.getContext('2d');
}
function renderPlasma(){
  pT+=0.01;
  let w=pOff.width,h=pOff.height,img=pOffCtx.createImageData(w,h),d=img.data;
  for(let py=0;py<h;py++) for(let px=0;px<w;px++){
    let v=Math.sin(px*0.27+pT)+Math.sin(py*0.21+pT*1.1)+Math.sin((px+py)*0.13+pT*0.9)+Math.sin(Math.sqrt(px*px+py*py)*0.17+pT*1.3);
    let c=lerpR((v+4)/8+pT*0.07),idx=(py*w+px)*4;
    d[idx]=c[0];d[idx+1]=c[1];d[idx+2]=c[2];d[idx+3]=255;
  }
  pOffCtx.putImageData(img,0,0);
  pCtx.clearRect(0,0,pCanvas.width,pCanvas.height);
  pCtx.imageSmoothingEnabled=true;
  pCtx.drawImage(pOff,0,0,pCanvas.width,pCanvas.height);
  blooms=blooms.filter(b=>b.r<b.maxR);
  blooms.forEach(b=>{
    b.r+=3;
    let g=pCtx.createRadialGradient(b.x,b.y,0,b.x,b.y,b.r);
    g.addColorStop(0,rgb(b.color,b.alpha*(1-b.r/b.maxR)));g.addColorStop(1,'transparent');
    pCtx.beginPath();pCtx.arc(b.x,b.y,b.r,0,Math.PI*2);pCtx.fillStyle=g;pCtx.fill();
  });
}

// ── BOOT ──
const BOOTLINES=[
  "> SIGIL FORGE v∅.2","> Glyph engine......... READY",
  "> Meaning matrix....... LOADED","> Instability core..... ARMED",
  "> UWU layer............ ONLINE","> NOTE: the forge reads",
  ">       what you truly meant,",">       not what you think.","> Draw.",
];
function runBoot(){
  let el=S('btext'),delay=0;
  BOOTLINES.forEach((line,i)=>{
    delay+=i===0?300:145;
    setTimeout(()=>{
      let d=document.createElement('div');d.className='bline';
      if(i>=5&&i<=7) d.style.color='rgba(255,160,0,0.9)';
      d.textContent=line;el.appendChild(d);
    },delay);
  });
}
function activate(){
  S('boot').classList.add('hidden');
  setTimeout(()=>{S('boot').style.display='none';S('app').classList.add('visible');initAll();},700);
}

// ── TIMER ──
let sessStart;
function startTimer(){
  sessStart=Date.now();
  setInterval(()=>{
    let s=Math.floor((Date.now()-sessStart)/1000);
    applyEl('stime',el=>el.textContent=[Math.floor(s/3600),Math.floor((s%3600)/60),s%60].map(n=>String(n).padStart(2,'0')).join(':'));
  },1000);
}

// ── FORGE STATE ──
let sCanvas,sCtx, gCanvas,gCtx, cCanvas,cCtx, crackleCanvas,crackleCtx;
let strokes=[], currentStroke=null, isDrawing=false;
let instability=0, agingTimer=null, isExploding=false;
let readCount=0, glyphCount=0, filterMode='eldritch';

const AGE_SEC=12;

function initForge(){
  sCanvas=S('sigil-canvas');gCanvas=S('glitch-canvas');cCanvas=S('chroma-canvas');crackleCanvas=S('crackle-canvas');
  sCtx=sCanvas.getContext('2d');gCtx=gCanvas.getContext('2d');cCtx=cCanvas.getContext('2d');crackleCtx=crackleCanvas.getContext('2d');
  resizeAll();
  window.addEventListener('resize',resizeAll);
  let fw=S('forge-wrap');
  fw.addEventListener('touchstart',e=>{e.preventDefault();onDown(tPt(e));},{passive:false});
  fw.addEventListener('touchmove', e=>{e.preventDefault();onMove(tPt(e));},{passive:false});
  fw.addEventListener('touchend',  e=>{e.preventDefault();onUp();},{passive:false});
  fw.addEventListener('mousedown', e=>onDown(mPt(e)));
  fw.addEventListener('mousemove', e=>{if(isDrawing)onMove(mPt(e));});
  fw.addEventListener('mouseup',   ()=>onUp());
  fw.addEventListener('mouseleave',()=>{if(isDrawing)onUp();});
  animGlitch(); animCrackle();
}

function resizeAll(){
  let fw=S('forge-wrap'),w=fw.clientWidth,h=fw.clientHeight;
  [sCanvas,gCanvas,cCanvas].forEach(c=>{c.width=w;c.height=h;});
  let rb=document.querySelector('.reading-body');
  if(rb){crackleCanvas.width=rb.clientWidth;crackleCanvas.height=rb.clientHeight;}
  redrawSigil();
}

function tPt(e){ let t=e.changedTouches[0],r=sCanvas.getBoundingClientRect(); return {x:t.clientX-r.left,y:t.clientY-r.top,t:Date.now()}; }
function mPt(e){ let r=sCanvas.getBoundingClientRect(); return {x:e.clientX-r.left,y:e.clientY-r.top,t:Date.now()}; }

function onDown(pt){
  if(isExploding) return;
  isDrawing=true; clearAging(); hideHint();
  currentStroke={points:[pt],color:lerpR(RT*0.4+strokes.length*0.17)};
}
function onMove(pt){
  if(!isDrawing||!currentStroke||isExploding) return;
  currentStroke.points.push(pt); glyphCount++;
  let pts=currentStroke.points,n=pts.length; if(n<2) return;
  sCtx.beginPath();sCtx.moveTo(pts[n-2].x,pts[n-2].y);sCtx.lineTo(pts[n-1].x,pts[n-1].y);
  sCtx.strokeStyle=rgb(currentStroke.color,0.9);sCtx.lineWidth=2.5;sCtx.lineCap='round';
  sCtx.shadowColor=rgb(currentStroke.color,0.65);sCtx.shadowBlur=8;sCtx.stroke();sCtx.shadowBlur=0;
}
function onUp(){
  if(!isDrawing) return; isDrawing=false;
  if(currentStroke&&currentStroke.points.length>2){
    strokes.push(currentStroke);
    setStat(filterMode==='uwu'?'sigil accepted owo ✦':'SIGIL RECORDED');
    startAging(); updateFooter();
  }
  currentStroke=null;
}

function startAging(){
  clearAging(); instability=0;
  agingTimer=setInterval(()=>{
    instability=Math.min(instability+0.1/AGE_SEC,1);
    if(instability>=1){clearAging();explode();}
  },100);
}
function clearAging(){ if(agingTimer){clearInterval(agingTimer);agingTimer=null;} instability=0; }

function redrawSigil(){
  if(!sCtx) return;
  sCtx.clearRect(0,0,sCanvas.width,sCanvas.height);
  strokes.forEach(s=>{
    if(s.points.length<2) return;
    sCtx.beginPath();sCtx.moveTo(s.points[0].x,s.points[0].y);
    s.points.slice(1).forEach(p=>sCtx.lineTo(p.x,p.y));
    sCtx.strokeStyle=rgb(s.color,0.9);sCtx.lineWidth=2.5;sCtx.lineCap='round';sCtx.lineJoin='round';
    sCtx.shadowColor=rgb(s.color,0.6);sCtx.shadowBlur=8;sCtx.stroke();sCtx.shadowBlur=0;
  });
}

// ── GLITCH ANIM ──
function animGlitch(){
  requestAnimationFrame(animGlitch);
  if(!gCtx||!cCtx) return;
  if(strokes.length===0&&!isExploding){gCtx.clearRect(0,0,gCanvas.width,gCanvas.height);cCtx.clearRect(0,0,cCanvas.width,cCanvas.height);return;}
  if(isExploding) return;
  let w=gCanvas.width,h=gCanvas.height,inst=instability,isUwu=filterMode==='uwu';

  // Redraw sigil with age effects
  sCtx.clearRect(0,0,sCanvas.width,sCanvas.height);
  strokes.forEach((s,si)=>{
    if(s.points.length<2) return;
    let dc=lerpR(RT*0.4+si*0.15+inst*0.35);
    sCtx.beginPath();sCtx.moveTo(s.points[0].x,s.points[0].y);
    s.points.slice(1).forEach(p=>sCtx.lineTo(p.x,p.y));
    sCtx.strokeStyle=rgb(dc,0.9-inst*0.15);sCtx.lineWidth=2.5+inst*4;
    sCtx.lineCap='round';sCtx.lineJoin='round';
    sCtx.shadowColor=rgb(dc,0.45+inst*0.45);sCtx.shadowBlur=8+inst*22;sCtx.stroke();sCtx.shadowBlur=0;
    if(inst>0.28){
      let bc=lerpR(RT*0.4+si*0.15+0.5);
      sCtx.beginPath();sCtx.moveTo(s.points[0].x+inst*5,s.points[0].y);
      s.points.slice(1).forEach(p=>sCtx.lineTo(p.x+inst*5,p.y));
      sCtx.strokeStyle=rgb(bc,inst*0.22);sCtx.lineWidth=5+inst*10;
      sCtx.shadowColor=rgb(bc,0.35);sCtx.shadowBlur=14;sCtx.stroke();sCtx.shadowBlur=0;
    }
  });

  gCtx.clearRect(0,0,w,h);
  for(let i=0;i<Math.floor(inst*(isUwu?2:7));i++){
    if(Math.random()>inst*0.65) continue;
    let col=isUwu?lerpR(0.08+Math.random()*0.22):lerpR(Math.random());
    gCtx.fillStyle=rgb(col,isUwu?inst*0.07:inst*0.16);
    gCtx.fillRect(Math.random()*8-4,Math.random()*h,w,isUwu?1+Math.random():1+Math.random()*3);
  }
  for(let i=0;i<Math.floor(inst*inst*(isUwu?25:70));i++){
    let col=isUwu?lerpR(0.06+Math.random()*0.22):lerpR(Math.random());
    gCtx.fillStyle=rgb(col,0.25+Math.random()*0.5);
    gCtx.fillRect(Math.random()*w,Math.random()*h,1+Math.random()*(isUwu?2:3),1+Math.random()*(isUwu?1.5:2.5));
  }
  if(!isUwu&&inst>0.45){
    const RR=['ψ','Φ','Ω','∑','∆','◈','⬡','⊕','◉','⊗'];
    for(let i=0;i<Math.floor(inst*inst*4);i++){
      if(Math.random()>0.45) continue;
      gCtx.font=`${10+Math.random()*14}px VT323`;
      gCtx.fillStyle=rgb(lerpR(Math.random()),inst*0.65);
      gCtx.fillText(RR[Math.floor(Math.random()*RR.length)],Math.random()*w,Math.random()*h);
    }
  }
  if(isUwu&&inst>0.2){
    const US=['✦','♡','˚','✧'];
    for(let i=0;i<Math.floor(inst*3);i++){
      if(Math.random()>0.35) continue;
      gCtx.font=`${8+Math.random()*10}px serif`;
      gCtx.fillStyle=rgb(lerpR(0.08+Math.random()*0.22),inst*0.55);
      gCtx.fillText(US[Math.floor(Math.random()*US.length)],Math.random()*w,Math.random()*h);
    }
  }
  cCtx.clearRect(0,0,cCanvas.width,cCanvas.height);
  if(inst>0.22){
    let sh=inst*(isUwu?3:9);
    cCtx.save();cCtx.globalAlpha=inst*(isUwu?0.07:0.15);cCtx.globalCompositeOperation='screen';
    cCtx.drawImage(sCanvas,-sh,0);cCtx.drawImage(sCanvas,sh,0);cCtx.restore();
  }
}

let crackleAmt=0;
function animCrackle(){
  requestAnimationFrame(animCrackle);
  if(!crackleCtx) return;
  let c=crackleCtx,w=crackleCanvas.width,h=crackleCanvas.height;
  c.clearRect(0,0,w,h); if(crackleAmt<=0) return;
  crackleAmt=Math.max(0,crackleAmt-1.2);
  for(let i=0;i<crackleAmt;i++){
    c.fillStyle=rgb(lerpR(Math.random()),0.2+Math.random()*0.3);
    c.fillRect(Math.random()*w,Math.random()*h,1+Math.random()*2,1);
  }
  if(Math.random()<crackleAmt*0.015){
    c.fillStyle=rgb(lerpR(Math.random()),0.07);
    c.fillRect(0,Math.random()*h,w,1+Math.random()*2);
  }
}

// ── EXPLOSION ──
function explode(){
  if(isExploding||strokes.length===0) return;
  isExploding=true;
  setStat(filterMode==='uwu'?'reading ur sigil bby >///<':'READING THE SIGIL');
  let reading=interpretSigil(strokes,filterMode);
  let bursts=0,bInt=setInterval(()=>{
    bursts++; renderBurst();
    if(bursts>=10){clearInterval(bInt);doExplode(reading);}
  },55);
}

function renderBurst(){
  let w=gCanvas.width,h=gCanvas.height,isUwu=filterMode==='uwu';
  gCtx.clearRect(0,0,w,h);
  for(let i=0;i<(isUwu?4:12);i++){
    gCtx.fillStyle=rgb(isUwu?lerpR(0.08+Math.random()*0.22):lerpR(Math.random()),isUwu?0.12:0.28);
    gCtx.fillRect(0,Math.random()*h,w,isUwu?1:1+Math.random()*4);
  }
  for(let i=0;i<(isUwu?40:180);i++){
    gCtx.fillStyle=rgb(lerpR(Math.random()),0.45);
    gCtx.fillRect(Math.random()*w,Math.random()*h,1+Math.random()*4,1+Math.random()*2);
  }
}

function doExplode(reading){
  readCount++;
  fireWoosh(filterMode);
  let fm=S('fmod'),fr=fm.getBoundingClientRect();
  let cx=fr.left+fr.width/2,cy=fr.top+fr.height/2;
  for(let i=0;i<7;i++) setTimeout(()=>spawnBloom(cx+(Math.random()-0.5)*180,cy+(Math.random()-0.5)*100,lerpR(Math.random())),i*65);
  if(filterMode==='uwu') spawnUwuSparkles();

  // Dissolve sigil
  crackleAmt=60;
  let fs=0,fi=setInterval(()=>{
    fs++;
    sCtx.fillStyle='rgba(0,0,0,0.14)';sCtx.fillRect(0,0,sCanvas.width,sCanvas.height);
    if(fs>16){
      clearInterval(fi);
      // FULL CLEAR — this is the key fix
      sCtx.clearRect(0,0,sCanvas.width,sCanvas.height);
      gCtx.clearRect(0,0,gCanvas.width,gCanvas.height);
      cCtx.clearRect(0,0,cCanvas.width,cCanvas.height);
    }
  },50);

  setTimeout(()=>{
    strokes=[];
    instability=0;
    isExploding=false;
    showReading(reading);
    showHint();
    setStat(filterMode==='uwu'?'da void has spoken uwu ✦':'THE VOID HAS SPOKEN');
    updateFooter();
  },900);
}

function showReading(text){
  let ri=S('ridle'),rt=S('rtext');
  ri.style.display='none';
  rt.classList.remove('show','glitching');
  rt.style.opacity=''; // clear inline style — let CSS class handle it
  rt.textContent='';rt.setAttribute('data-text','');
  crackleAmt=55;
  setTimeout(()=>{
    rt.textContent=text;rt.setAttribute('data-text',text);
    rt.classList.add('show');
    setTimeout(()=>rt.classList.add('glitching'),350);
  },200);
}

function clearForge(){
  clearAging();strokes=[];instability=0;isExploding=false;
  if(sCtx) sCtx.clearRect(0,0,sCanvas.width,sCanvas.height);
  if(gCtx) gCtx.clearRect(0,0,gCanvas.width,gCanvas.height);
  if(cCtx) cCtx.clearRect(0,0,cCanvas.width,cCanvas.height);
  let ri=S('ridle'),rt=S('rtext');
  ri.style.display='';rt.classList.remove('show','glitching');rt.textContent='';rt.setAttribute('data-text','');
  showHint();setStat(filterMode==='uwu'?'— draw again bby owo —':'— awaiting inscription —');updateFooter();
}

function hideHint(){ applyEl('forge-hint',el=>el.style.opacity='0'); }
function showHint() { applyEl('forge-hint',el=>el.style.opacity='1'); }

// ── INTERPRETATION ──
function analyzeSigil(strokes){
  let all=strokes.flatMap(s=>s.points);
  if(all.length<3) return {roundness:0.5,direction:'linear',crossings:0,axis:'diagonal',size:'medium',complexity:'simple'};
  let xs=all.map(p=>p.x),ys=all.map(p=>p.y);
  let minX=Math.min(...xs),maxX=Math.max(...xs),minY=Math.min(...ys),maxY=Math.max(...ys);
  let w=maxX-minX,h=maxY-minY;
  let perim=0;
  for(let i=1;i<all.length;i++){let dx=all[i].x-all[i-1].x,dy=all[i].y-all[i-1].y;perim+=Math.sqrt(dx*dx+dy*dy);}
  let roundness=w*h*0.7>0?Math.min(1,Math.PI*4*(w*h*0.7)/(perim*perim)):0.3;
  let pts=strokes[0].points,turn=0,prev=null;
  for(let i=1;i<pts.length;i++){
    let a=Math.atan2(pts[i].y-pts[i-1].y,pts[i].x-pts[i-1].x);
    if(prev!==null){let d=a-prev;if(d>Math.PI)d-=Math.PI*2;if(d<-Math.PI)d+=Math.PI*2;turn+=d;}
    prev=a;
  }
  let direction=Math.abs(turn)<0.6?'linear':turn>0?'clockwise':'counterclockwise';
  let crossings=0;
  for(let si=0;si<strokes.length&&crossings<5;si++){
    for(let sj=si;sj<strokes.length&&crossings<5;sj++){
      let ps=strokes[si].points,qs=strokes[sj].points;
      let step=Math.max(1,Math.floor(ps.length/10)),step2=Math.max(1,Math.floor(qs.length/10));
      for(let a=0;a<ps.length-step&&crossings<5;a+=step)
        for(let b=(si===sj?a+step*2:0);b<qs.length-step2&&crossings<5;b+=step2)
          if(segX(ps[a],ps[a+step],qs[b],qs[b+step2])) crossings++;
    }
  }
  let axis='diagonal';
  if(w>0&&h>0){let r=w/h;if(r>1.9)axis='horizontal';else if(r<0.52)axis='vertical';}
  let diag=Math.sqrt(w*w+h*h),sd=Math.sqrt(sCanvas.width*sCanvas.width+sCanvas.height*sCanvas.height);
  let sf=diag/sd;
  let size=sf<0.22?'small':sf>0.52?'large':'medium';
  let tp=strokes.reduce((s,st)=>s+st.points.length,0);
  let complexity=strokes.length===1?(tp<20?'simple':'flowing'):strokes.length===2?'layered':'complex';
  return {roundness,direction,crossings,axis,size,complexity};
}
function segX(p1,p2,p3,p4){
  let ax=p2.x-p1.x,ay=p2.y-p1.y,bx=p4.x-p3.x,by=p4.y-p3.y,c=ax*by-ay*bx;
  if(Math.abs(c)<0.001) return false;
  let t=((p3.x-p1.x)*by-(p3.y-p1.y)*bx)/c,u=((p3.x-p1.x)*ay-(p3.y-p1.y)*ax)/c;
  return t>=0&&t<=1&&u>=0&&u<=1;
}
function pick(a){ return a[Math.floor(Math.random()*a.length)]; }

const D={
  subj:{e:{small:['A secret','A wound','A seed','A debt','Something hidden'],medium:['The current','Your shadow','A threshold','The signal','The thread'],large:['A force without name','Something vast','An old covenant','The gap between layers','What watches']},u:{small:['a tiny secret ✦','a lil wound owo','a smol seed :3','a lil debt bby'],medium:['da current','ur shadow uwu','a thweshold owo','da signal :3'],large:['a HUGE force !!!','something VAST owo','an old covenant uwu','da gap between wayews :3']}},
  act:{e:{clockwise:['summons','calls toward','gathers','draws inward','awakens'],counterclockwise:['releases','disperses','severs','banishes','dissolves'],linear:['names','marks','binds','identifies','traverses']},u:{clockwise:['summons uwu','calls toward ✦','gathews owo','awakens bby'],counterclockwise:['weweases','disperses °~°','severs (ouch)','banishes owo'],linear:['names uwu','mawks ✦','binds bby','identifies :3']}},
  rnd:{e:{round:['in the shape of a returning','through cycles of forgetting','without beginning or end','as something closed upon itself'],sharp:['with precision that cuts','through angles that refuse to curve','at exact coordinates of intent','where geometry becomes violence']},u:{round:['in da shape of a wetuwning uwu','thwough cycles of forgetting °~°','without beginning or end owo','as something closed bby'],sharp:['with pwecision that cuts ✦','thwough angles that wefuse to cuwve','at exact coowdinates :3','where geometwy becomes violence owo']}},
  cross:{e:['','','at the crossing of two intentions','where three paths disagree','tangled in its own certainty','bound by what it contradicts'],u:['','','at da cwossing of two intentions uwu','where thwee paths disagwee owo','tangled in its own cewtainty :3','bound by what it contwadicts bby']},
  axis:{e:{horizontal:'A boundary is crossed.',vertical:'Something shifts between layers.',diagonal:'Transformation is the only constant.',none:''},u:{horizontal:'a boundawy is cwossed uwu',vertical:'something shifts between wayews owo',diagonal:'twansfowmation is da onwy constant :3',none:''}},
  conseq:{e:{simple:['Something small shifts.','A small door opens.','One thread loosens.','The signal adjusts.'],flowing:['It moves like water. You cannot catch it.','Something flows to where you are not.','A current changes direction permanently.'],layered:['Two things become one. Neither survives unchanged.','The layers now touch. This was not permitted.','What was separate now shares a frequency.'],complex:['The system cannot reconcile this.','Too many intentions. The void must choose.','Something ancient is taking notes.','This will have consequences you will not recognize as such.']},u:{simple:['something smol shifts uwu','a smol door opens :3','one thwead woosens owo','da signal adjusts °~°'],flowing:['it moves wike water bby. u cannot catch it owo','something fwows where u awe not uwu','a cuwwent changes diwection pewmanently :3'],layered:['two things become one bby. neithew survives unchanged owo','da wayews touch. this was not pewmitted >///<','what was sepawate shawes a fwequency uwu'],complex:['da system cannot weconcile this owo','too many intentions bby. da void must choose uwu','something ancient is taking notes °~°','this will have consequences u wont wecognize as such uwu']}},
};

function interpretSigil(strokes,mode){
  let A=analyzeSigil(strokes),L=mode==='uwu'?'u':'e';
  let subj=pick(D.subj[L][A.size]);
  let act=pick(D.act[L][A.direction]||D.act[L].linear);
  let rnd=A.roundness>0.32?pick(D.rnd[L].round):pick(D.rnd[L].sharp);
  let cross=A.crossings>=2?(D.cross[L][Math.min(A.crossings,5)]||''):'';
  let ax=(D.axis[L][A.axis])||'';
  let conseq=pick(D.conseq[L][A.complexity]);
  return [`${subj} ${act}`,rnd,cross,ax,conseq].filter(s=>s.trim()).join('\n');
}

// ── FILTER ──
function toggleFilter(){
  filterMode=filterMode==='eldritch'?'uwu':'eldritch';
  if(filterMode==='uwu') spawnUwuSparkles();
  fireWoosh(filterMode);
  setStat(filterMode==='uwu'?'UWU MODE ACTIVATED owo ✦':'ELDRITCH MODE ACTIVE');
}

// ── WOOSH ──
function fireWoosh(mode){
  let ov=S('woosh');ov.innerHTML='';
  let cx=window.innerWidth/2,cy=window.innerHeight/2,maxR=Math.max(cx,cy)*1.5;
  for(let i=0;i<(mode==='uwu'?10:8);i++){
    let ring=document.createElement('div');ring.className='wring';
    let col=mode==='uwu'?lerpR(0.08+i*0.08):lerpR(RT*0.4+i*0.14);
    let sz=14+i*5;
    ring.style.cssText=`left:${cx-sz/2}px;top:${cy-sz/2}px;width:${sz}px;height:${sz}px;border-color:${rgb(col)};box-shadow:0 0 14px ${rgb(col,0.6)};`;
    ov.appendChild(ring);
    let d=i*48,dur=660+i*55;
    setTimeout(()=>{ring.style.transition=`transform ${dur}ms cubic-bezier(0.1,0.9,0.3,1),opacity ${dur}ms ease-out`;ring.style.transform=`scale(${maxR*(0.28+i*0.1)/(sz/2)})`;ring.style.opacity='0';},d);
    setTimeout(()=>ring.remove(),d+dur+100);
  }
  if(mode==='uwu') for(let i=0;i<4;i++) setTimeout(()=>spawnBloom(),i*90);
}

// ── UWU ──
const UWUS=['✦','♡','˚','◟','uwu','owo','°~°',':3','✧','˘','◡','>///<'];
function spawnUwuSparkles(){
  for(let i=0;i<7+Math.floor(Math.random()*5);i++){
    setTimeout(()=>{
      let el=document.createElement('div');el.className='uwusp';
      el.textContent=UWUS[Math.floor(Math.random()*UWUS.length)];
      let col=lerpR(0.05+Math.random()*0.25);
      el.style.cssText=`color:${rgb(col)};text-shadow:0 0 8px ${rgb(col,0.7)};left:${10+Math.random()*80}%;bottom:${25+Math.random()*40}%;`;
      document.body.appendChild(el);setTimeout(()=>el.remove(),1500);
    },i*100);
  }
}

function setStat(t){ applyEl('state-lbl',el=>el.textContent=t); }
function updateFooter(){ applyEl('ftval',el=>el.textContent=`glyphs=${glyphCount.toString().padStart(4,'0')} reads=${readCount.toString().padStart(4,'0')}`); }

function mainLoop(){ requestAnimationFrame(mainLoop); updateTheme(); renderPlasma(); }

function initAll(){ startTimer(); initPlasma(); initForge(); mainLoop(); }
runBoot();
</script>
</body>
</html>
